<div class="graphic-container">
  <!-- Bouton pour ouvrir/fermer le panneau principal -->
  <button mat-mini-fab class="open-graphic-button" (click)="togglePanel()" matTooltip="Graphique"
    matTooltipPosition="below" aria-label="Ouvrir le panneau des graphiques">
    <mat-icon>pie_chart</mat-icon>
  </button>

  <div *ngIf="isPanelOpen" class="graphic-panel mat-elevation-z8" cdkDrag>
    <div class="graphic-header" cdkDragHandle>
      <button *ngIf="currentView === 'chart'" mat-icon-button (click)="showGrid()">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <span class="active-chart-title">{{ activeChartTitle }}</span>
      <button mat-icon-button (click)="togglePanel()" aria-label="Fermer le panneau" matTooltip="Fermer">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="graphic-content">
      <!-- Colonne de Gauche -->
      <div class="chart-display-area">

        <!-- Grille de Sélection ou apercu -->

        <div *ngIf="currentView === 'library'" class="admin-chart-grid">


          <div *ngFor="let box of previewBoxes" class="chart-preview-box" (click)="loadPreset(box.id)">

            <div class="chart-preview-image">
              <img [src]="box.svgPath" [alt]="box.title" />
            </div>

            <div class="chart-preview-title">
              <h4>{{ box.title }}</h4>
            </div>
          </div>

        </div>





        <!--  MODIFICATION : Ajout de #chartHost pour pouvoir mesurer la taille du conteneur -->
        <div *ngIf="currentView === 'chart'" class="active-chart-container" #chartHost>
          <div echarts [options]="chartOptions" [initOpts]="{renderer: 'svg'}" class="chart-instance"
            (chartInit)="onChartInit($event)">
          </div>
          <!-- <div echarts [options]="chartOptions" [initOpts]="{renderer: 'canvas'}" class="chart-instance"
            (chartInit)="onChartInit($event)">
          </div> -->
        </div>

      </div>



      <div class="preset-selection-area">

        <div class="preset-list" *ngIf="!showDataTable">
          <div class="preset-title">Graphiques Prédéfinis</div>
          <ul>
            <li *ngFor="let preset of adminPresets" class="clickable-list-item" (click)="loadPreset(preset.id)">
              {{ preset.name }}
            </li>
            <li *ngIf="adminPresets.length === 0" class="empty-list-message">
              Aucun preset administrateur.
            </li>
          </ul>
        </div>


        <div class="preset-list" *ngIf="!showDataTable">
          <div class="preset-title">Mes Graphiques</div>
          <ul>
            <li *ngFor="let preset of userPresets" class="list-item-with-menu">

              <span class="preset-name" (click)="loadPreset(preset.id)">
                {{ preset.name }}
              </span>

              <button mat-icon-button class="menu-trigger" [matMenuTriggerFor]="userMenu"
                (click)="$event.stopPropagation()" aria-label="Options du graphique">
                <mat-icon>more_vert</mat-icon>
              </button>

              <mat-menu #userMenu="matMenu">
                <button mat-menu-item (click)="deletePreset(preset.id, $event)">
                  <mat-icon>delete</mat-icon>
                  <span>Supprimer</span>
                </button>
              </mat-menu>

            </li>
            <li *ngIf="userPresets.length === 0" class="empty-list-message">
              Vous n'avez aucun graphique.
            </li>
          </ul>
        </div>

        <div class="preset-list data-table-wrapper" *ngIf="showDataTable">
          <div class="preset-title">Données du Graphique</div>
          <div class="data-table-container">
            <table>
              <thead>
                <tr>
                  <th *ngFor="let col of tableColumns">
                    <input class="data-table-header-input" [(ngModel)]="tableColumnAliases[col]"
                      [name]="'alias-' + col">
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let row of tableData">
                  <td *ngFor="let col of tableColumns">{{ row[col] }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div *ngIf="tableData.length === 0" class="empty-list-message">
            Aucune donnée à afficher.
          </div>
        </div>

      </div>
    </div>






    <div class="graphic-footer">
      <button mat-icon-button matTooltip="Personnaliser" (click)="customizeChart()">
        <mat-icon>settings</mat-icon>
      </button>
      <button mat-icon-button matTooltip="Filtrer à la sélection" (click)="filterToSelection()">
        <mat-icon>filter_alt</mat-icon>
      </button>
      <button mat-icon-button matTooltip="Afficher/Masquer les données" (click)="toggleDataTable()">
        <mat-icon>table_chart</mat-icon> </button>
      <button mat-icon-button matTooltip="Exporter" (click)="exportChart()">
        <mat-icon>save_alt</mat-icon>
      </button>

    </div>
  </div>